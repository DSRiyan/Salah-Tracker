<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Salah History</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg1: #f7efe3;
      --bg2: #fae6c8;
      --card: rgba(255, 255, 255, 0.95);
      --accent: #a06c2a;
      --muted: #6c5431;
      --bad: #d9534f;
    }

    * {
      font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
      font-size: 16px;
      line-height: 1.6;
      color: #3a2b14;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(150deg, var(--bg1), var(--bg2));
      padding: 18px;
      display: flex;
      justify-content: center;
      color: var(--muted);
    }

    .container {
      max-width: 960px;
      width: 100%;
      background: var(--card);
      padding: 22px;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(120, 90, 35, 0.20);
    }

    h2 {
      text-align: center;
      margin-bottom: 16px;
      color: var(--accent);
      font-weight: 700;
      font-size: 28px;
    }

    .card {
      background: white;
      padding: 18px;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(120, 90, 35, 0.10);
      margin-bottom: 18px;
    }

    .monthContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    /* Modern Month Picker Box */
    .monthWrapper {
      width: 100%;
      background: #fff7ed;
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      color: var(--accent);
      font-size: 18px;
      font-weight: 600;
      box-shadow: 0 6px 18px rgba(150, 110, 40, 0.08);
      cursor: pointer;
      transition: 0.2s ease;
      position: relative;
    }

    .monthWrapper:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 26px rgba(150, 110, 40, 0.12);
    }

    /* Hide the real input */
    .monthWrapper input {
      opacity: 0;
      position: absolute;
      inset: 0;
      cursor: pointer;
    }

    /* Stats */
    .statsRow {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .stat {
      flex: 1;
      min-width: 160px;
      background: #fff7ed;
      border-radius: 14px;
      padding: 14px;
      text-align: center;
      box-shadow: 0 6px 18px rgba(150, 110, 40, .5);
    }

    .stat p {
      color: var(--accent);
      font-size: 26px;
      font-weight: 700;
      margin: 0;
    }

    /* Table */
    .tableWrap {
      margin-top: 12px;
      max-height: 420px;
      overflow: auto;
      border-radius: 14px;
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 12px;
      border-bottom: 1px solid #f3e7d4;
      text-align: center;
      font-size: 18px;
    }

    th {
      background: #fff1dd;
      position: sticky;
      top: 0;
      font-weight: 700;
      font-size: 19px;
      color: var(--accent);
    }

    .deleteBtn {
      padding: 8px 10px;
      border: none;
      border-radius: 8px;
      background: var(--bad);
      color: white;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
    }

    .btnBack {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      margin-top: 16px;
      letter-spacing: 1px;
      box-shadow: 0 6px 18px rgba(120, 90, 35, 0.15);
    }

    .btnBack:hover {
      transform: translateY(-2px);
      transition: 0.2s;
    }
  </style>
</head>

<body>

  <div class="container">

    <h2>Salah Analysis</h2>

    <!-- MONTH SUMMARY -->
    <div class="card">
      <h3 style="text-align:center;margin-bottom:10px;color:var(--accent);font-size:24px;font-weight:700;">
         Salah Monthly Summary
      </h3>

      <div class="monthContainer">
        <div class="monthWrapper" onclick="document.getElementById('monthPicker').showPicker()">
          <span id="monthText">Select Month</span>
          <input type="month" id="monthPicker">
        </div>
      </div>

      <div class="statsRow">
        <div class="stat">
          <h4>Total Completed Salah</h4>
          <p id="completedTotal">0</p>
        </div>

        <div class="stat">
          <h4>Total Missed Salah</h4>
          <p id="missedTotal">0</p>
        </div>

        <div class="stat">
          <h4>Days With All 5</h4>
          <p id="daysAll5">0</p>
        </div>
      </div>

      <div style="width:100%;height:280px;margin-top:12px;">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>

    <!-- DAILY RECORD TABLE -->
    <div class="card">
      <h3 style="text-align:center;margin-bottom:10px;color:var(--accent);font-size:24px;font-weight:700;">
        Your Daily Records:)
      </h3>

      <div class="tableWrap">
        <table id="historyTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Missed</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>

    <button class="btnBack" onclick="goBack()">← Back to Tracker</button>

  </div>

  <script>
    const STORAGE_KEY = "salahHistory";
    const PRAYERS = ["fajr", "dhuhr", "asr", "maghrib", "isha"];

    /* Convert Dhuhr → Jummah on Fridays */
    function convertNamesForFriday(dateISO, missedList = []) {
      let d = new Date(dateISO);
      let isFriday = d.getDay() === 5;
      if (!isFriday) return missedList;
      return missedList.map(p => p === "dhuhr" ? "Jummah" : p);
    }

    function loadHistory() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    }

    function normalize(entry) {
      if (!entry) return null;
      let iso = entry.dateISO;
      if (!iso && entry.date) iso = new Date(entry.date).toISOString().slice(0, 10);
      if (!iso) return null;
      let prayers = {};
      PRAYERS.forEach(p => prayers[p] = entry.prayers?.[p] ?? false);
      let missed = PRAYERS.filter(p => !prayers[p]);
      missed = convertNamesForFriday(iso, missed);
      return { dateISO: iso, prayers, missed, completedAll: missed.length === 0 };
    }

    function getCleanHistory() {
      return loadHistory()
        .map(normalize)
        .filter(Boolean)
        .sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO));
    }

    let monthlyChart;

    function renderMonthly() {
      const picker = document.getElementById("monthPicker");
      let monthVal = picker.value || new Date().toISOString().slice(0, 7);

      document.getElementById("monthText").textContent = monthVal;

      const [yr, mo] = monthVal.split("-").map(Number);

      const hist = getCleanHistory().filter(e => {
        const d = new Date(e.dateISO);
        return d.getFullYear() === yr && d.getMonth() + 1 === mo;
      });

      const days = new Date(yr, mo, 0).getDate();
      const totalPossible = days * 5;

      let completed = 0;
      let daysAll5 = 0;

      hist.forEach(e => {
        let done = PRAYERS.reduce((s, p) => s + (e.prayers[p] ? 1 : 0), 0);
        completed += done;
        if (done === 5) daysAll5++;
      });

      let missed = totalPossible - completed;

      document.getElementById("completedTotal").textContent = completed;
      document.getElementById("missedTotal").textContent = missed;
      document.getElementById("daysAll5").textContent = daysAll5;

      const ctx = document.getElementById("monthlyChart").getContext("2d");
      if (monthlyChart) monthlyChart.destroy();

      monthlyChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Completed", "Missed"],
          datasets: [{ data: [completed, missed], backgroundColor: ["#a06c2a", "#d9534f"] }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: "bottom" } }
        }
      });
    }

    function renderTable() {
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";

      const hist = getCleanHistory();

      hist.forEach(e => {
        const tr = document.createElement("tr");

        let missedDisplay = e.missed.length
          ? e.missed.map(x => x.charAt(0).toUpperCase() + x.slice(1)).join(", ")
          : "—";

        tr.innerHTML = `
          <td>${formatDate(e.dateISO)}</td>
          <td>${missedDisplay}</td>
          <td><button class="deleteBtn" data-id="${e.dateISO}">Delete</button></td>
        `;

        tbody.appendChild(tr);
      });

      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.onclick = () => deleteEntry(btn.dataset.id);
      });
    }

    function deleteEntry(iso) {
      let data = loadHistory();
      data = data.filter(e => e.dateISO !== iso);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      renderAll();
    }

    function formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString("en-IN", {
        day: "2-digit",
        month: "2-digit",
        year: "2-digit"
      });
    }

    function renderAll() {
      renderMonthly();
      renderTable();
    }

    document.getElementById("monthPicker").onchange = renderAll;
    document.getElementById("monthPicker").value = new Date().toISOString().slice(0, 7);

    renderAll();

    function goBack() {
      window.location.href = "index.html";
    }
  </script>

</body>

</html>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Salah History</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg1: #cde5ff;
      --bg2: #eaf6ff;
      --card: white;
      --accent: #4a83d6;
      --muted: #4b6b86;
      --bad: #d9534f;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(160deg, var(--bg1), var(--bg2));
      font-family: Poppins, sans-serif;
      padding: 18px;
      display: flex;
      justify-content: center;
      color: var(--muted);
    }

    .container {
      max-width: 960px;
      width: 100%;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(20, 48, 88, 0.12);
    }

    h2 {
      text-align: center;
      margin-bottom: 12px;
    }

    .card {
      background: white;
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(10, 25, 50, 0.06);
      margin-bottom: 16px;
    }

    .monthContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 18px;
  margin-top: 5px;
}

.monthLabel {
  font-size: 15px;
  font-weight: 600;
  color: var(--muted);
  margin-bottom: 8px;
}

.monthBox {
  width: 80%;
  max-width: 300px;
}

.selectModern {
  width: 100%;
  padding: 12px 14px;
  font-size: 15px;
  border: none;
  border-radius: 12px;
  background: #f6fbff;
  box-shadow: 0 6px 18px rgba(10, 25, 50, 0.06);
  text-align: center;
  color: var(--accent);
  font-weight: 600;
  outline: none;
  cursor: pointer;
  transition: 0.2s ease;
}

.selectModern:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 24px rgba(10, 25, 50, 0.10);
}

.selectModern:focus {
  outline: 2px solid var(--accent);
}


    .selectBox {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #e7eefc;
      margin-top: 6px;
    }

    .statsRow {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .stat {
      flex: 1;
      min-width: 160px;
      background: #f6fbff;
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
    }

    .stat h4 {
      font-size: 14px;
      margin-bottom: 6px;
      color: var(--muted);
    }

    .stat p {
      color: var(--accent);
      font-size: 22px;
      font-weight: 700;
      margin: 0;
    }

    .tableWrap {
      margin-top: 12px;
      max-height: 420px;
      overflow: auto;
      border-radius: 12px;
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 10px;
      border-bottom: 1px solid #eaf0fb;
      text-align: center;
    }

    th {
      background: #f0f6ff;
      position: sticky;
      top: 0;
    }

    .deleteBtn {
      padding: 8px 10px;
      border: none;
      border-radius: 8px;
      background: var(--bad);
      color: white;
      cursor: pointer;
      font-weight: 700;
    }

    .btnBack {
      display: block;
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      margin-top: 14px;
    }
  </style>
</head>

<body>

  <div class="container">
    <h2>Salah History</h2>

    <!-- MONTHLY SUMMARY ONLY -->
    <div class="card">
      <h3 style="text-align:center;margin-bottom:10px;">Monthly Summary</h3>

      <div class="monthContainer">
  
        <div class="monthBox">
          <input type="month" id="monthPicker" class="selectModern">
        </div>
      </div>


      <div class="statsRow">
        <div class="stat">
          <h4>Total Completed Salah</h4>
          <p id="completedTotal">0</p>
        </div>

        <div class="stat">
          <h4>Total Missed Salah</h4>
          <p id="missedTotal">0</p>
        </div>

        <div class="stat">
          <h4>Days With All 5</h4>
          <p id="daysAll5">0</p>
        </div>
      </div>

      <div style="width:100%;height:280px;margin-top:12px;">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>

    <!-- DAILY TABLE -->
    <div class="card">
      <h3 style="text-align:center;margin-bottom:10px;">Daily Records (Newest First)</h3>

      <div class="tableWrap">
        <table id="historyTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Missed</th>
              <th>All 5?</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <button class="btnBack" onclick="goBack()">Back to Tracker</button>
  </div>

  <script>
    const STORAGE_KEY = "salahHistory";
    const PRAYERS = ["fajr", "dhuhr", "asr", "maghrib", "isha"];

    function loadHistory() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    }

    function normalize(entry) {
      if (!entry) return null;

      let iso = entry.dateISO;
      if (!iso && entry.date) iso = new Date(entry.date).toISOString().slice(0, 10);
      if (!iso) return null;

      let prayers = {};
      PRAYERS.forEach(p => prayers[p] = entry.prayers?.[p] ?? false);

      let missed = PRAYERS.filter(p => !prayers[p]);

      return {
        dateISO: iso,
        prayers: prayers,
        missed: missed,
        completedAll: missed.length === 0
      };
    }

    function getCleanHistory() {
      return loadHistory().map(normalize).filter(Boolean).sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO));
    }

    /* MONTHLY SUMMARY */
    let monthlyChart;

    function renderMonthly() {
      let monthVal = document.getElementById("monthPicker").value;
      if (!monthVal) monthVal = new Date().toISOString().slice(0, 7);

      const [yr, mo] = monthVal.split("-").map(Number);

      const hist = getCleanHistory().filter(e => {
        const d = new Date(e.dateISO);
        return d.getFullYear() === yr && d.getMonth() + 1 === mo;
      });

      const days = new Date(yr, mo, 0).getDate();
      const totalPossible = days * 5;

      let completed = 0;
      let daysAll5 = 0;

      hist.forEach(e => {
        let done = PRAYERS.reduce((s, p) => s + (e.prayers[p] ? 1 : 0), 0);
        completed += done;
        if (done === 5) daysAll5++;
      });

      let missed = totalPossible - completed;

      document.getElementById("completedTotal").textContent = completed;
      document.getElementById("missedTotal").textContent = missed;
      document.getElementById("daysAll5").textContent = daysAll5;

      const ctx = document.getElementById("monthlyChart").getContext("2d");
      if (monthlyChart) monthlyChart.destroy();
      monthlyChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Completed", "Missed"],
          datasets: [{
            data: [completed, missed],
            backgroundColor: ["#4a83d6", "#d9534f"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom" },
            tooltip: {
              callbacks: {
                label: (c) => `${c.label}: ${c.parsed}`
              }
            }
          }
        }
      });
    }

    /* TABLE */
    function renderTable() {
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";

      const hist = getCleanHistory();

      hist.forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td>${formatDate(e.dateISO)}</td>
      <td>${e.missed.length ? e.missed.map(x => x.charAt(0).toUpperCase() + x.slice(1)).join(", ") : "—"}</td>
      <td>${e.completedAll ? "✔️" : "❌"}</td>
      <td><button class="deleteBtn" data-id="${e.dateISO}">Delete</button></td>
    `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.onclick = () => deleteEntry(btn.dataset.id);
      });
    }

    function deleteEntry(iso) {
      let data = loadHistory();
      data = data.filter(e => (e.dateISO || "").slice(0, 10) !== iso);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      renderAll();
    }

    function formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString("en-IN", { day: "2-digit", month: "2-digit", year: "2-digit" });
    }

    /* INIT */
    function renderAll() {
      renderMonthly();
      renderTable();
    }

    document.getElementById("monthPicker").onchange = renderAll;
    document.getElementById("monthPicker").value = new Date().toISOString().slice(0, 7);

    renderAll();

    function goBack() { window.location.href = "index.html"; }
  </script>

</body>

</html>
